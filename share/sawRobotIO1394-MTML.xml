<?xml version="1.0" encoding="utf-8"?>
<!-- Author: klee , Zihan Chen  -->
<!-- zihan.chen@jhu.edu -->
<!-- Todo:  -->
<!-- 1 Verify math & offset  -->
<!-- 2 Check GearRatio and Ktorque on Manuall -->
<Config>
  <!-- Definition of da Vinci left PSM -->
  <!-- This one is MODIFIED!!! -->
  <!-- Check the conversion functions and values after -->

  <!-- ========== Drive ============ -->
  <!-- DACCNT = AmpsToBits * MCUR_A  16 bit DAC-->
  <!-- AmpsToBits = (2^16) / (6.25 * 2) = 5242.88 bit/A -->
  <!-- Offset is 32768 for AmpIO firewire -->

  <!-- MCUR_A = BitsToFeedbackAmps * ADCCNT   16 bit ADC -->
  <!-- BitsToFeedbackAmps = (6.25 * 2) / (2^16) = 0.000190737774 -->
  <!-- Offset is of AmpToBits offest / AmpsToBits scale = 32768 / 5242.88 = 6.25 Amps -->
  <!-- Torque_Nm = GearRatio * Ktorque * MCUR_A -->
  <!-- NmToAmps = 1 / GearRatio / Ktorque -->

  <!-- MaxCurrent = see DaVinci manual -->

  <!-- ========= Encoder ========= -->
  <!-- PosSI = (ENC_CNT - OFFSET) * 360 / CPT * Pitch / GearRatio   -->
  <!-- Revolute: Pitch = 1     Prismatic: Pitch = m/deg  -->
  <!-- BitsToPosSI = 360 / CPT * Pitch / GearRatio -->
  <!-- Q2: BitsToDeltaPosSI ?   BitsToDeltaT -->

  <!-- ======== AnalogIn ========= -->
  <!-- 16 bit ADC to 0-4.5V (Ref Voltage) -->  
  <!-- BitsToVolts = (4.5 - 0) / 2^16 = 0.0000686656 V/bit -->
  <!-- AnalogInVolts = BitsToVolts * ADCCNT -->
  <!-- PotSI = Slope * AnalogInVolts + Intercept -->
  <!-- Slope: m/V   Intercept: m  HW specific -->

  <Robot Name="MTML" NumOfActuator="8" NumOfJoint="8">
    
    <Actuator ActuatorID="0" BoardID="0" AxisID="0" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="-5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="-0.000190738" Offset="6.25"/>
            <NmToAmps Scale="0.359398"/>
            <MaxCurrent Value="0.67" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="-0.001419" Offset="0"/>
            <BitsToDeltaPosSI Scale="-4360.20" Offset="0"/>
            <BitsToDeltaT Scale="0.125" Offset="0"/>
            <CountsPerTurn Value="4000"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="76.1417" Offset="-155.8559"/>
        </AnalogIn>
    </Actuator>

    <Actuator ActuatorID="1" BoardID="0" AxisID="1" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="0.000190738" Offset="-6.25"/>
            <NmToAmps Scale="0.456885"/>
            <MaxCurrent Value="0.67" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="0.001804" Offset="0"/>
            <BitsToDeltaPosSI Scale="5542.90" Offset="0"/>
            <BitsToDeltaT Scale="0.25" Offset="0"/>
            <CountsPerTurn Value="4000"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="75.09872" Offset="-143.336851"/>
        </AnalogIn>
    </Actuator>

    <Actuator ActuatorID="2" BoardID="0" AxisID="2" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="0.000190738" Offset="-6.25"/>
            <NmToAmps Scale="0.381541"/>
            <MaxCurrent Value="0.67" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="0.001507" Offset="0"/>
            <BitsToDeltaPosSI Scale="4628.83" Offset="0"/>
            <BitsToDeltaT Scale="1" Offset="0"/>
            <CountsPerTurn Value="4000"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="75.098727" Offset="-163.00649"/>
        </AnalogIn>
    </Actuator>

    <Actuator ActuatorID="3" BoardID="0" AxisID="3" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="0.000190738" Offset="-6.25"/>
            <NmToAmps Scale="2.164238"/>
            <MaxCurrent Value="0.67" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="0.008547" Offset="0"/>
            <BitsToDeltaPosSI Scale="26256.41" Offset="0"/>
            <BitsToDeltaT Scale="1" Offset="0"/>
            <CountsPerTurn Value="4000"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="-75.62024" Offset="116.82609"/>
        </AnalogIn>
    </Actuator>

    <Actuator ActuatorID="4" BoardID="1" AxisID="0" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="-5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="-0.000190738" Offset="6.25"/>
            <NmToAmps Scale="6.092286"/>
            <MaxCurrent Value="0.59" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="-0.169632" Offset="0"/>
            <BitsToDeltaPosSI Scale="-521109.711" Offset="0"/>
            <BitsToDeltaT Scale="1" Offset="0"/>
            <CountsPerTurn Value="64"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="-79.27087" Offset="222.02687"/>
        </AnalogIn>
    </Actuator>

    <Actuator ActuatorID="5" BoardID="1" AxisID="1" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="0.000190738" Offset="-6.25"/>
            <NmToAmps Scale="-6.092286"/>
            <MaxCurrent Value="0.59" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="0.169632" Offset="0"/>
            <BitsToDeltaPosSI Scale="521109.771" Offset="0"/>
            <BitsToDeltaT Scale="1" Offset="0"/>
            <CountsPerTurn Value="64"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="78.22783" Offset="-173.13065"/>
        </AnalogIn>
    </Actuator>

    <Actuator ActuatorID="6" BoardID="1" AxisID="2" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="-5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="-0.000190738" Offset="6.25"/>
            <NmToAmps Scale="-12.184572"/>
            <MaxCurrent Value="0.407" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="-0.339264" Offset="0"/>
            <BitsToDeltaPosSI Scale="-104221.954" Offset="0"/>
            <BitsToDeltaT Scale="1" Offset="0"/>
            <CountsPerTurn Value="64"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="41.72151" Offset="-69.28778"/>
        </AnalogIn>
    </Actuator>

    <Actuator ActuatorID="7" BoardID="1" AxisID="3" Pos1="ENC" Pos2="POT">
        <Drive>
            <AmpsToBits Scale="5242.880000" Offset="32768"/>
            <BitsToFeedbackAmps Scale="0.000190738" Offset="-6.25"/>
            <NmToAmps Scale="12.184572"/>
            <MaxCurrent Value="0.0" Unit="A"/>
        </Drive>
        <Encoder>
            <BitsToPosSI Scale="1.0" Offset="0"/>
            <BitsToDeltaPosSI Scale="1.0" Offset="0"/>
            <BitsToDeltaT Scale="1.0" Offset="0"/> <!-- the last actuator value is not encoder based, uses analog in for Hall effect -->
            <CountsPerTurn Value="1.0"/>
        </Encoder>
        <AnalogIn>
            <BitsToVolts Scale="6.86656e-05" Offset="0"/>
            <VoltsToPosSI Scale="-0.019311" Offset="0.082146"/>
        </AnalogIn>
    </Actuator>

<!-- Coupling matrices for Actuator->Joint Transformation, Joint->Actuator Transformation    -->
<!-- ActuatorTorque->JointTorque Transformation, and JointTorque->ActuatorTorque Transformation   -->

<!-- This coupling matrices are based on the information provided on the following document -->
<!-- User Guide: The da Vinci Research Kit by Intuitive Surgical, Inc. Revision: Unknown -->
<!-- The following coupling information is for the Master Tool Manipulator only -->

<!-- Gear ratio from Axis1 to Axis7 -->
<!-- nt1:63.41, nt2:49.88 nt3:59.71 nt4:10.53 nt5:33.16 nt6:33.16 nt7:16.58 -->
<!-- Radius of ilder on joint3(r43): 0.5515in, radius of idler on joint4(r44): 0.8235in -->

<!-- q1=qa1, q2=qa2, q3=qa3 - qa2, q4=qa4 - (r43/r44) * (qa3 - qa2)
     q5=qa5, q6=qa6, q7=qa7
     r43 = 0.5515
     r44 = 0.8235
     r43/r44 = .66970248937462052216

     NOTE: all matrices are from/to joint to/from actuators.  To get to the motor
     level, you need to include the gear ratios.  When compared to the research kit
     manual, note that we use ta1, not tm1, etc.
      -->
    <Coupling Value="1">
        <ActuatorToJointPosition>
            <Row Val="1.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 1.000 0.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 -1.00 1.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.6697 -0.6697 1.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 1.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 1.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 1.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 0.000 1.000"/>
        </ActuatorToJointPosition>

<!-- aq1 = q1, qa2 = q2, qa3 = q3+q2, qa4 = q4 + q3*r43/r44
     qa5 = q5, qa6 = q6, qa7 = q7 -->
        <JointToActuatorPosition>
            <Row Val="1.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 1.000 0.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 1.000 1.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.6697 1.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 1.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 1.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 1.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 0.000 1.000"/>
        </JointToActuatorPosition>

<!-- t1 = ta1, t2 = ta2 + ta3, t3 = ta3 + (r43/r44)*ta4
     t4 = ta4, t5 = ta5, t6 = ta6, t7 = ta7 -->
        <ActuatorToJointTorque>
            <Row Val="1.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 1.000 1.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 1.000 0.6697 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 1.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 1.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 1.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 1.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 0.000 1.000"/>
        </ActuatorToJointTorque>

<!-- ta1 = t1, ta2 = t2 - t3 + (r43/r44)*t4, ta3 = t3 -(r43/r44) * t4
     ta4 = t4, ta5 = t5, ta6 = t6, ta7 = t7 -->
        <JointToActuatorTorque>
            <Row Val="1.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 1.000 -1.000 0.6697 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 1.000 -0.6697 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 1.000 0.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 1.000 0.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 1.000 0.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 1.000 0.000"/>
            <Row Val="0.000 0.000 0.000 0.000 0.000 0.000 0.000 1.000"/>
        </JointToActuatorTorque>
    </Coupling>
  </Robot>

<!-- List of Digital Inputs related to MTML, mostly the foot pedal.
     The 2nd right pedal does not work. 
     Their names do not represent provided interface yet. -->
<!-- Board 5 Digital Input list -->
  <DigitalIn Name="MTML-D30" BoardID="0" BitID="0" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D31" BoardID="0" BitID="1" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D32" BoardID="0" BitID="2" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D33" BoardID="0" BitID="3" Pressed="0" Trigger="all" />

  <DigitalIn Name="MTML-D40" BoardID="0" BitID="4" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D41" BoardID="0" BitID="5" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D42" BoardID="0" BitID="6" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D43" BoardID="0" BitID="7" Pressed="0" Trigger="all" />

  <DigitalIn Name="MTML-D50" BoardID="0" BitID="8" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D51" BoardID="0" BitID="9" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D52" BoardID="0" BitID="10" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D53" BoardID="0" BitID="11" Pressed="0" Trigger="all" />

<!-- Board 7 Digital Input list -->
  <DigitalIn Name="CLUTCH" BoardID="1" BitID="0" Pressed="0" Trigger="all" />
  <DigitalIn Name="CAM-" BoardID="1" BitID="1" Pressed="0" Trigger="all" />
  <DigitalIn Name="CAM+" BoardID="1" BitID="2" Pressed="0" Trigger="all" />
  <DigitalIn Name="COAG" BoardID="1" BitID="3" Pressed="0" Trigger="all" />

  <DigitalIn Name="CAMERA" BoardID="1" BitID="4" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D11" BoardID="1" BitID="5" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D12" BoardID="1" BitID="6" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D13" BoardID="1" BitID="7" Pressed="0" Trigger="all" />

  <DigitalIn Name="MTML-D20" BoardID="1" BitID="8" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D21" BoardID="1" BitID="9" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D22" BoardID="1" BitID="10" Pressed="0" Trigger="all" />
  <DigitalIn Name="MTML-D23" BoardID="1" BitID="11" Pressed="1" Trigger="all" />

</Config>
